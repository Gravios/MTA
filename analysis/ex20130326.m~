s = MTASession('jg05-20120309',{'ang'});
s = MTATrial(s,[],'all');


nn = ~isnan(s.ang(:,1,2,1));

swin = 7;
lwin = 243;

newser = s.ang(:,1,2,1);
newser(~isnan(newser))=0;
newser(isnan(newser)) =1;
newser = ~newser;
newper = ThreshCross(newser,0,0.5);

angd = [s.ang(nn,2,3,1)-s.ang(nn,1,2,1),...
        s.ang(nn,5,6,1)-s.ang(nn,4,5,1),...
        s.ang(nn,5,7,1)-s.ang(nn,4,5,1)];


angd = [s.ang(nn,4,5,1)-s.ang(nn,3,4,1),...
        s.ang(nn,2,3,1)-s.ang(nn,1,2,1),...
        s.ang(nn,5,7,1)-s.ang(nn,4,5,1)];


nxyz = Filter0(gausswin(swin)./sum(gausswin(swin)),sq(s.xyz(nn,3,:)));
hxyz = Filter0(gausswin(swin)./sum(gausswin(swin)),sq(s.xyz(nn,7,:)));

angd_pc =  princomp(angd);

nangd = (angd_pc*angd')';

% $$$ 
% $$$ a = [1,2;1,3;2,3]';
% $$$ k = 1;
% $$$ figure
% $$$ for i = a,
% $$$ subplotfit(k,3);
% $$$ rangd = (angd_pc([i(1),i(2)],:)*angd')';
% $$$ plot(rangd(:,1),rangd(:,2),'.');
% $$$ k = k+1;
% $$$ end


a = [1,2;1,3;2,3]';
for i = a,
figure
rangd = (angd_pc([i(1),i(2)],:)*angd')';
%plot(rangd(:,1),rangd(:,2),'.');
[O,XB,YB] = hist2([rangd(:,1),rangd(:,2)],100,100);caxis([0,300]);
end
[X,Y] = meshgrid(1:100);
figure,mesh(X,Y,log10(O+0.0001))

[xpos1,ypos1] = ginput;
[xpos2,ypos2] = ginput;
[xpos3,ypos3] = ginput;
[xpos4,ypos4] = ginput;
rin1 = inpolygon(rangd(:,1),rangd(:,2),xpos1,ypos1);
rin2 = inpolygon(rangd(:,1),rangd(:,2),xpos2,ypos2);
rin3 = inpolygon(rangd(:,1),rangd(:,2),xpos3,ypos3);
rin4 = inpolygon(rangd(:,1),rangd(:,2),xpos4,ypos4);
figure,hold on,
plot(nxyz(:,1),nxyz(:,2),'.','markersize',4)
plot(nxyz(rin1,1),nxyz(rin1,2),'.','color','g','markersize',5)
plot(nxyz(rin2,1),nxyz(rin2,2),'.','color','r','markersize',5)
plot(nxyz(rin3,1),nxyz(rin3,2),'.','color','m','markersize',5)
plot(nxyz(rin4,1),nxyz(rin4,2),'.','color','c','markersize',5)
figure,hold on,
plot(nxyz(:,3),'.','markersize',4)
plot(find(rin1),nxyz(rin1,3),'.','color','g','markersize',5)
plot(find(rin2),nxyz(rin2,3),'.','color','r','markersize',5)
plot(find(rin3),nxyz(rin3,3),'.','color','m','markersize',5)
plot(find(rin4),nxyz(rin4,3),'.','color','c','markersize',5)


Bhv = MTABhv(s,'m20130311');
wper = SelectPeriods(Bhv.getState('walk').state,newper,'p',1,1);
gper = SelectPeriods(Bhv.getState('groom').state,newper,'p',1,1);


v = Filter0(gausswin(lwin)./sum(gausswin(lwin)),sqrt(sum(diff(nxyz(:,[1,2])).^2,2)));



figure,plot(v(rin1),'.')
figure,hist2([log10(v(rin1)*12),clip(hxyz(rin1,3),0,150)],100,100)
xl = xlim;
yl = ylim;
xlim(xl);
ylim(yl);
figure,plot(log10(v(rin1)),clip(hxyz(rin1,3),0,150),'.')

[xp,yp] = ginput;
vin1 = inpolygon(log10(v(rin1)),clip(hxyz(rin1,3),0,150),xp,yp);
nvin = rin1;
nvin(rin1) = vin1;

figure,hold on,
plot(hxyz(:,3),'.','color','b','markersize',4);
plot(find(rin1),hxyz(rin1,3),'.','color','g','markersize',4)
plot(find(nvin),hxyz(nvin,3),'.','color','c','markersize',5)
Lines(wper(:,1),[],'k');
Lines(wper(:,2),[],'r');


%% ex20130325 start

s = MTASession('jg05-20120309');
s = MTATrial(s,[],'all');
swin = 7;
lwin = 243;
comb = zeros(size(s.xyz,1),1,3);
comb(:,1,:) = Filter0(gausswin(swin)./sum(gausswin(swin)),s.com(s.Model.rb({'spine_lower','pelvis_root','spine_middle','spine_upper'})));
comh = zeros(size(s.xyz,1),1,3);
comh(:,1,:) = Filter0(gausswin(swin)./sum(gausswin(swin)),s.com(s.Model.rb({'head_back','head_left','head_front','head_right'})));
s = s.addMarker('body_com','[0,0,255]',...
                {{'spine_lower','body_com',[0,0,255]},...
                 {'pelvis_root','body_com',[0,0,255]},...
                 {'spine_middle','body_com',[0,0,255]},...
                 {'spine_upper','body_com',[0,0,255]}},comb);
s = s.addMarker('head_com','[0,0,0]',...
                {{'head_back','head_com',[0,0,255]},...
                 {'head_left','head_com',[0,0,255]},...
                 {'head_front','head_com',[0,0,255]},...
                 {'head_right','head_com',[0,0,255]}},comh);
s = s.load_ang(1);


angdn = [s.ang(:,1,2,1)-s.ang(:,1,10,1),...
        s.ang(:,2,3,1)-s.ang(:,1,10,1),...
        s.ang(:,3,4,1)-s.ang(:,1,10,1)];
angdn = unwrap(angdn);
sang =Filter0(gausswin(lwin)./sum(gausswin(lwin)),angdn);
ang = angdn-sang;

nn = ~isnan(s.ang(:,1,2,1));
wang = WhitenSignal(ang(nn,:),[],1);

yc=[];f=[];t=[];phi=[];fstat=[];
[yc,f,t,phi,fstat] = mtchglong(ang,2^8,s.xyzSampleRate,2^7,0.875*2^7,[],[],[],[0,40]);


ynn = ~isnan(yc(:,1,1,1));
% $$$ figure,hist(log10(mean(yc(ynn,f<5,i,i),2)),2000)

for i = 1:size(yc,3),
yclp(:,i) = log10(mean(yc(:,f<5,i,i),2));
end

ygper = mean(yc(:,f<5,i,i),2)>10^-6;
ygperiods = ThreshCross(ygper,0.5,1);

% $$$ figure
% $$$ k=1;for i= 1:size(yc,3),sp(k)=subplotfit(k,size(yc,3));imagesc(t,f,log10(yc(:,:,i,i))'),axis xy,k=k+1;
% $$$ Lines(Bhv.getState('walk').state(1:end-1,1)./s.xyzSampleRate,[],'k');
% $$$ Lines(Bhv.getState('walk').state(1:end-1,2)./s.xyzSampleRate,[],'r');
% $$$ end
% $$$ linkaxes(sp,'xy')
% $$$ 
% $$$ figure
% $$$ k=1;for i= 1:size(yc,3),sp(k)=subplotfit(k,size(yc,3));imagescnan(phi(:,:,1,i)',[],1,1),axis xy,k=k+1;,end
% $$$ linkaxes(sp,'xy')
% $$$ figure,imagescnan(phi(:,:,1,2)',[],1,1),axis xy
% $$$ 
% $$$ figure
% $$$ k=1;for i= 1:size(yc,3),sp(k)=subplotfit(k,size(yc,3));imagesc(t,f,fstat(:,:,i)'),axis xy,k=k+1;,end
% $$$ linkaxes(sp,'xy')


figure
plot(Filter0(gausswin(lwin)./sum(gausswin(lwin)),sum(fstat(:,[2,3,4,5],1),2))),axis xy;

Bhv = MTABhv(s,'m20130311');

figure,imagescnan(phi(:,:,1,3)',[],1,1),axis xy
Lines(Bhv.getState('walk').state(1:end-1,1)./s.xyzSampleRate.*(1/diff(t(1:2))),[],'k');
Lines(Bhv.getState('walk').state(1:end-1,2)./s.xyzSampleRate.*(1/diff(t(1:2))),[],'r');


%nphi = sq(sum(cat(3,phi(:,f<10,1,2),phi(:,f<10,1,3),phi(:,f<10,2,3)),2));
nphi = sq(circ_mean(cat(3,phi(:,f<6,1,2),phi(:,f<6,1,3),phi(:,f<6,2,3)),[],2));
figure,imagescnan(nphi',[],1,1),axis xy
Lines(Bhv.getState('walk').state(1:end-1,1)./s.xyzSampleRate.*(1/diff(t(1:2))),[],'k')
Lines(Bhv.getState('walk').state(1:end-1,2)./s.xyzSampleRate.*(1/diff(t(1:2))),[],'w')



%% ex20130326 primary modifications bellow

nphi = sq(circ_mean(cat(3,phi(:,f<6,1,2),phi(:,f<6,1,3),phi(:,f<6,2,3)),[],2));

nphi = nphi - repmat(circ_mean(nphi(~isnan(nphi),:)),size(nphi,1),1);

nphi(nphi<0) = nphi(nphi<0) + pi;
nphi(nphi>0) = nphi(nphi>0) - pi;
nphi_pc = princomp(nphi(ynn,:));

bhvs = {'all','walk','turnR','rear','groom','shake'};
ybp={};bnn={};bphis={};bycs={};

mode='pca';
%mode='def';nnn

%dim = [1,3];
%dim = [1,2];
dim = [2,3];

fig_h=[];
fig_h(1) = figure;
set(gcf,'Name',['phaseXphase ' num2str(dim)]);
fig_h(2) = figure;
set(gcf,'Name',['powerXphase ' num2str(dim)]);
for i = 1:length(bhvs),
    if i==1,
        switch mode
          case 'def'
            bphis{1} = nphi;
          case 'pca'
            bphis{1} = (nphi_pc*nphi')';
        end
        bycs{1} = yclp;
        bnn{1} = ~isnan(bphis{1}(:,1))&ygper;
    else
        ybp{i} = round(Bhv.getState(bhvs{i}).state(1:end-1,:)./s.xyzSampleRate.*(1/diff(t(1:2))));
        bphis{i} = SelectPeriods(bphis{1},IntersectRanges(ybp{i},ygperiods),'c',[],1);
        bycs{i} = SelectPeriods(bycs{1},IntersectRanges(ybp{i},ygperiods),'c',[],1);
        bnn{i} = ~isnan(bphis{i}(:,1));
    end
    set(0,'CurrentFigure',fig_h(1));
    subplot(320+i),
    hist2([bphis{i}(bnn{i},dim(1)),bphis{i}(bnn{i},dim(2))],50,50);
    title(bhvs{i});
    set(0,'CurrentFigure',fig_h(2));
    subplot(320+i),
    hist2([bycs{i}(bnn{i},dim(1)),bphis{i}(bnn{i},dim(2))],50,50)
    title(bhvs{i});
end


figure,
k=1;
for i = 1:3,
for j = 1:3,
subplot(330+k)
hist2([yclp(~isnan(bphis{1}(:,1)),i),bphis{1}(~isnan(bphis{1}(:,1)),j)],50,50)
title(['tot powerXphase ' num2str([i,j])]);
k = k+1;
end
end


figure,plot(sum(sang(:,:),2)),
Lines(cat(1,Bhv.getState('turnR').state(:,1),Bhv.getState('turnL').state(:,1)),[],'k');
Lines(cat(1,Bhv.getState('turnR').state(:,2),Bhv.getState('turnL').state(:,2)),[],'r');