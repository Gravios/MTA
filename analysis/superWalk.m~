Trial = MTATrial('jg05-20120309',{'ang'},'all');

Trial.Bhv = MTABhv(Trial,'m20130311');

win = 7;
xyz = reshape(Filter0(gausswin(win)./sum(gausswin(win)),Trial.xyz),size(Trial.xyz,1),size(Trial.xyz,2),size(Trial.xyz,3));
v = sqrt(sum(diff(xyz).^2,3));
w_v = SelectPeriods(v,Trial.Bhv.getState('walk').state,'c',[],1);
t_v = SelectPeriods(v,cat(1,Trial.Bhv.getState('turnL').state,Trial.Bhv.getState('turnR').state),'c',[],1);

hold on,hist(log10(t_v(t_v(:,1)~=0,1)),1000)
hold on,hist(log10(t_v(t_v(:,1)~=0,1)),1000,'color','g')
figure,hist(log10(t_v(t_v(:,1)~=0,1)),1000,'color','g')
figure,hist(log10(v(v(:,1)~=0,1)),1000)

for i= 1:size(v,2),subplotfit(i,size(v,2));,hist(log10(v(v(:,i)~=0,i)),1000),end
plot(diff(v(1:10000,1)))



win = 241;
comb = Filter0(gausswin(win)./sum(gausswin(win)),Trial.com(Trial.Model.rb({'spine_lower','pelvis_root','spine_middle','spine_upper'})));
comh = Filter0(gausswin(win)./sum(gausswin(win)),Trial.com(Trial.Model.rb({'head_back','head_left','head_front','head_right'})));

comb = sqrt(sum(diff(comb(:,[1,2])).^2,2));
comh = sqrt(sum(diff(comh(:,[1,2])).^2,2));

figure,hist(log10(comb(comb~=0)),1000)
figure,hist(log10(comh(comh~=0)),1000)

wcomb = SelectPeriods(comb,Trial.Bhv.getState('walk').state,'c',[],1);
wcomh = SelectPeriods(comh,Trial.Bhv.getState('walk').state,'c',[],1);
tcomb = SelectPeriods(comb,cat(1,Trial.Bhv.getState('turnL').state,Trial.Bhv.getState('turnR').state),'c',[],1);
tcomh = SelectPeriods(comh,cat(1,Trial.Bhv.getState('turnL').state,Trial.Bhv.getState('turnR').state),'c',[],1);

figure
subplot(411);hist(log10(wcomb(wcomb~=0)),1000)
subplot(412);hist(log10(wcomh(wcomh~=0)),1000)
subplot(413);hist(log10(tcomb(tcomb~=0)),1000)
subplot(414);hist(log10(tcomh(tcomh~=0)),1000)
ForAllSubplots('xlim([-5,1])')

nwcomb = SelectPeriods(comb,ThreshCross(~WithinRanges(1:size(Trial.xyz,1)-1,Trial.Bhv.getState('walk').state),0.5,1),'c',[],1);
nwcomh = SelectPeriods(comh,ThreshCross(~WithinRanges(1:size(Trial.xyz,1)-1,Trial.Bhv.getState('walk').state),0.5,1),'c',[],1);
ntcomb = SelectPeriods(comb,ThreshCross(~WithinRanges(1:size(Trial.xyz,1)-1,cat(1,Trial.Bhv.getState('turnL').state,Trial.Bhv.getState('turnR').state)),0.5,1),'c',[],1);
ntcomh = SelectPeriods(comh,ThreshCross(~WithinRanges(1:size(Trial.xyz,1)-1,cat(1,Trial.Bhv.getState('turnL').state,Trial.Bhv.getState('turnR').state)),0.5,1),'c',[],1);

figure
subplot(411);hist(log10(nwcomb(nwcomb~=0)),1000)
subplot(412);hist(log10(nwcomh(nwcomh~=0)),1000)
subplot(413);hist(log10(ntcomb(ntcomb~=0)),1000)
subplot(414);hist(log10(ntcomh(ntcomh~=0)),1000)
ForAllSubplots('xlim([-5,1])')

comv = [comb,comh];
for i =1:2,
comv(:,i) = ButFilter(comv(:,i),11,2./(Trial.xyzSampleRate/2),'low');
comv(:,i) = clip(comv(:,i),0.003,30);
end
figure,hist2([log10(comv(:,1)),log10(comv(:,2))],100,100)
caxis([0,700]);

wcomv = WhitenSignal(comv,[],1);

yc=[];f=[];t=[];
for i =1:size(wcomv,2),
[yc(:,:,i),f,t,phi,fstat] = mtchglong(wcomv(:,i),2^8,Trial.xyzSampleRate,2^7,0.875*2^7,[],[],[],[0,40]);
end


[yc,f,t,phi,fstat] = mtchglong(wcomv,2^8,Trial.xyzSampleRate,2^7,0.875*2^7,[],[],[],[0,40]);

k=1;for i= 1:size(yc,3)for j= 1:size(yc,4),sp(k)=subplotfit(k,size(yc,3)*size(yc,4));imagesc(t,f,log10(yc(:,:,j,i))'),axis xy,k=k+1;,end,end
linkaxes(sp,'xy')
%spectrum of vel or acc





hdav = diff(Filter0(gausswin(11)./sum(gausswin(11)),unwrap(Trial.ang(:,5,7,1))));
hdav(isnan(hdav)) = 0;
wv = WhitenSignal([diff(v(:,1)),diff(v(:,7)),hdav],[],1);

[ywhdav,f,t] = mtchglong(whdav,2^8,Trial.xyzSampleRate,2^7,0.875*2^7,[],[],[],[0,40]);


[y,f,t] = mtchglong(diff(v(:,1)),2^8,Trial.xyzSampleRate,2^7,0.875*2^7,[],[],[],[0,40]);
[yh,f,t] = mtchglong(diff(v(:,7)),2^8,Trial.xyzSampleRate,2^7,0.875*2^7,[],[],[],[0,40]);


figure,
sp(1) = subplot(211);
imagesc(t,f,log10(y')),axis xy
sp(2) = subplot(212);
imagesc(t,f,log10(yh')),axis xy
linkaxes(sp,'xy');


[ywb,f,t] = mtchglong(wv(:,1),2^8,Trial.xyzSampleRate,2^7,0.875*2^7,[],[],[],[0,40]);
[ywh,f,t] = mtchglong(wv(:,2),2^8,Trial.xyzSampleRate,2^7,0.875*2^7,[],[],[],[0,40]);


figure,
sp(1) = subplot(311);
imagesc(t,f,log10(ywb')),axis xy
caxis([-8,-2])
sp(2) = subplot(312);
imagesc(t,f,log10(ywh')),axis xy
caxis([-8,-2])
sp(3) = subplot(313);
imagesc(t,f,log10(ywhdav')),axis xy
caxis([-15,-4])
linkaxes(sp,'xy');
ForAllSubplots(['Lines(Trial.Bhv.getState(''walk'').state(:,1)./Trial.xyzSampleRate,[],''k'');',...
                'Lines(Trial.Bhv.getState(''walk'').state(:,2)./Trial.xyzSampleRate,[],''r'');'])


figure,imagesc(t,f,log10(y')),axis xy
Lines(Trial.Bhv.getState('walk').state(:,1)./Trial.xyzSampleRate,[],'k');
Lines(Trial.Bhv.getState('walk').state(:,2)./Trial.xyzSampleRate,[],'r');

Lines(Trial.Bhv.getState('walk').state(:,1),[],'k');
Lines(Trial.Bhv.getState('walk').state(:,2),[],'r');

Lines(Trial.Bhv.getState('groom').state(:,1)./Trial.xyzSampleRate,[],'k');
Lines(Trial.Bhv.getState('groom').state(:,2)./Trial.xyzSampleRate,[],'m');

wp = mean(y(:,f<5),2);

hd=nan(size(Trial.xyz,1),1);
for xseg=1:size(Trial.xyzPeriods,1),
    hd(Trial.xyzPeriods(xseg,1):Trial.xyzPeriods(xseg,2)-Trial.xyzPeriods(1)+1) = ...
        unwrap(Trial.ang(Trial.xyzPeriods(xseg,1):Trial.xyzPeriods(xseg,2)-Trial.xyzPeriods(1)+1,5,7,1));
end


tx = 0:1/Trial.xyzSampleRate:size(Trial.xyz,1)/Trial.xyzSampleRate;
[~,vi] = NearestNeighbour(tx,t,'both');
[~,wti] = NearestNeighbour(t,Trial.Bhv.getState('walk').state(:)./Trial.xyzSampleRate,'both');
wti=reshape(wti,2,[])';
wti=reshape(wti,[],1);
wti=reshape(wti',2,[])';

v_t = v(vi,7);

w_p = SelectPeriods(wp,wti,'c',[],1);
v_p = SelectPeriods(v_t,wti,'c',[],1);

figure,plot(v_t,log10(wp),'.')
hold on,plot(v_p,log10(w_p),'.','Color','g')

[~,ttil] = NearestNeighbour(t,Trial.Bhv.getState('turnL').state(:)./Trial.xyzSampleRate,'both');
ttil=reshape(ttil,2,[])';
ttil=reshape(ttil,[],1);
ttil=reshape(ttil',2,[])';

[~,ttir] = NearestNeighbour(t,Trial.Bhv.getState('turnR').state(:)./Trial.xyzSampleRate,'both');
ttir=reshape(ttir,2,[])';
ttir=reshape(ttir,[],1);
ttir=reshape(ttir',2,[])';

tti = cat(1,ttil,ttir);


t_p = SelectPeriods(wp,tti,'c',[],1);
vt_p = SelectPeriods(v_t,tti,'c',[],1);


hold on,plot(vt_p,log10(t_p),'.','Color','r')

% $$$ 
% $$$   [~,gi] = NearestNeighbour(t,Trial.Bhv.getState('groom').state(:)./Trial.xyzSampleRate,'both');
% $$$   gi=reshape(gi,2,[])';
% $$$   gi=reshape(gi,[],1);
% $$$   gi=reshape(gi',2,[])';
% $$$ 
% $$$   g_p = SelectPeriods(wp,gi,'c',[],1);
% $$$   vg_p = SelectPeriods(v_t,gi,'c',[],1);
% $$$ 
% $$$ hold on,plot(vg_p,log10(g_p),'.','Color','m')


fv = ButFilter(v(:,1),11,2./(Trial.xyzSampleRate/2),'low');
fv = clip(fv,0.005,40);
fvh = ButFilter(v(:,7),11,2./(Trial.xyzSampleRate/2),'low');
fvh = clip(fvh,0.005,40);
figure,hist2([log10(fv),log10(fvh)],100,100)
caxis([0,700]);

adfv=clip(abs(diff(fv)),0.005,1.2);
adfvh=clip(abs(diff(fvh)),0.005,1.2);

[~,fwpi] = SelectPeriods(fv,Trial.Bhv.getState('walk').state,'c',[],1);
[~,ftlpi] = SelectPeriods(fv,Trial.Bhv.getState('turnL').state,'c',[],1);
[~,ftrpi] = SelectPeriods(fv,Trial.Bhv.getState('turnR').state,'c',[],1);
ftpi = [ftlpi;ftrpi];

figure,plot(log10(fv),log10(fvh),'.')
hold on, plot(log10(fv(fwpi)),log10(fvh(fwpi)),'.','color','g')
hold on, plot(log10(fv(ftpi)),log10(fvh(ftpi)),'.','color','r')




% total spine angle feature
sfet = [Trial.ang(:,2,3,1),...
        Trial.ang(:,3,4,1),...
        Trial.ang(:,4,5,1),...
        Trial.ang(:,4,5,1)]...
        -repmat(Trial.ang(:,1,2,1),1,4);
sfet = unwrap(sfet);
sfet = Filter0(gausswin(win)./sum(gausswin(win)),sfet);

bsfet = ButFilter(sfet,11,2./(Trial.xyzSampleRate/2),'low');

bbsfet = ButFilter(sum(bsfet,2),11,2./(Trial.xyzSampleRate/2),'low');

num_fet = size(sfet,2);
for i = 1:num_fet
   sfet(isnan(sfet(:,i)),i) = mean(sfet(~isnan(sfet(:,i)),i));
end


sfet = [unwrap(Trial.ang(:,2,3,1))-unwrap(Trial.ang(:,1,2,1)),...
        unwrap(Trial.ang(:,3,4,1))-unwrap(Trial.ang(:,2,3,1)),...
        unwrap(Trial.ang(:,4,5,1))-unwrap(Trial.ang(:,3,4,1)),...
        unwrap(Trial.ang(:,5,7,1))-unwrap(Trial.ang(:,4,5,1))];
sfet = unwrap(sfet);
sfet = Filter0(gausswin(win)./sum(gausswin(win)),sfet);
bsfet = ButFilter(sum(sfet,2),11,6./(Trial.xyzSampleRate/2),'low');
tsfet = Filter0(gausswin(141)./sum(gausswin(141)),bsfet);



figure
plot(diff(diff(bsfet)))
Lines(Trial.Bhv.getState('turnL').state(:,1),[],'k');
Lines(Trial.Bhv.getState('turnL').state(:,2),[],'r');
Lines(Trial.Bhv.getState('turnR').state(:,1),[],'k');
Lines(Trial.Bhv.getState('turnR').state(:,2),[],'r');
Lines(Trial.Bhv.getState('walk').state(:,1),[],'g');
Lines(Trial.Bhv.getState('walk').state(:,2),[],'m');

Lines(Trial.Bhv.getState('rear').state(:,1),[],'g');
Lines(Trial.Bhv.getState('rear').state(:,2),[],'m');

[yta,fta,tta] = mtchglong(WhitenSignal(diff(bsfet)),2^10,Trial.xyzSampleRate,2^9,0.9375*2^9,[],[],[],[0,5]);


ttat = 1/Trial.xyzSampleRate:1/Trial.xyzSampleRate:size(Trial.xyz,1)/Trial.xyzSampleRate-1/Trial.xyzSampleRate';
figure,
sp(1) = subplot(211);
imagesc(tta,fta,log10(yta')),axis xy
sp(2) = subplot(212);
plot(ttat,diff(bsfet));
linkaxes(sp,'x');
Lines(Trial.Bhv.getState('turnR').state(:,1)./Trial.xyzSampleRate,[],'k');
Lines(Trial.Bhv.getState('turnR').state(:,2)./Trial.xyzSampleRate,[],'r');
Lines(Trial.Bhv.getState('walk').state(:,1)./Trial.xyzSampleRate,[],'g');
Lines(Trial.Bhv.getState('walk').state(:,2)./Trial.xyzSampleRate,[],'m');


binSize = 100;%ms
halfBins = 50;
normalization = 'hz';
bsfetZeroCross = ThreshCross(bsfet,0,40)
poni  = round((bsfetZeroCross-1)./Trial.xyzSampleRate.*Trial.lfpSampleRate);
clear('fccg')
clear('ffccg')
[fccg tbin ] = Trains2CCG({poni,Trial.res},{1,Trial.clu},binSize,halfBins,Trial.lfpSampleRate,normalization);
uClu = unique(Trial.clu);
sccg = zeros(size(fccg,1),size(Trial.map,1));
sccg(:,uClu) = sq(fccg(:,1,2:end));
ffccg = zeros(size(fccg,1),2,size(Trial.map,1));
for k=1:size(Trial.map,1)
    ffccg(:,k) = Filter0(gausswin(3)./sum(gausswin(3)),sccg(:,k));
end

figure,for unit = 1:116,bar(tbin/1000,ffccg(:,unit));axis tight;grid on,waitforbuttonpress,end


dbsfet = diff(bsfet-tsfet);
tzeroind = LocalMinima(abs(dbsfet),5*120,0.00002);
tmaxind = LocalMinima(-dbsfet,4*120,-0.02);
tminind = LocalMinima(dbsfet,4*120,-0.02);
taind = LocalMinima(-abs(dbsfet),1,-0.02);
dtaind = diff(taind);
gdtaind = find(dtaind<200);
ntaind = round(taind(gdtaind)+dtaind(gdtaind)/2);
[~,ntind] =setdiff(round(ntaind./30),round([tmaxind;tminind]./30));
ntaind = ntaind(ntind);
ntaind = ntaind(LocalMinima(-diff(ntaind),0,-4*120));
pposi  = round((tmaxind-1)./Trial.xyzSampleRate.*Trial.lfpSampleRate);
pnegi  = round((tminind-1)./Trial.xyzSampleRate.*Trial.lfpSampleRate);
pzeri  = round((ntaind-1)./Trial.xyzSampleRate.*Trial.lfpSampleRate);
[fccg tbin ] = Trains2CCG({pposi,pnegi,pzeri,Trial.res},{1,2,3,Trial.clu},binSize,halfBins,Trial.lfpSampleRate,normalization);
uClu = unique(Trial.clu);
sccg = zeros(size(fccg,1),3,size(Trial.map,1));
sccg(:,:,uClu) = sq(fccg(:,1:3,4:end));
ffccg = zeros(size(fccg,1),3,size(Trial.map,1));
for k=1:size(Trial.map,1)
    for l=1:3
        ffccg(:,l,k) = Filter0(gausswin(3)./sum(gausswin(3)),sccg(:,l,k));
    end
end

%figure,for unit = 1:116,for i=1:2,subplot(210+i),bar(tbin/1000,ffccg(:,i,unit));axis tight;grid on,title(num2str(unit)),end,waitforbuttonpress,end

figure,bar(tbin./1000,fccg(:,1,1)),axis tight
figure,for unit = 1:116,for i=1:3,subplot(size(ffccg,2)*100+10+i),bar(tbin/1000,ffccg(:,i,unit));axis tight;grid on,title(num2str(unit)),end,waitforbuttonpress,end






Trial = Trial.load_CluRes;
Trial.Bhv =MTABhv(Trial,'m20130304')
Trial.Fet =MTAFet(Trial,'m20130304')
pposi  = round((Trial.Bhv.getState('turnL').state(:,1)-1)./Trial.xyzSampleRate.*Trial.lfpSampleRate);
pnegi  = round((Trial.Bhv.getState('turnR').state(:,1)-1)./Trial.xyzSampleRate.*Trial.lfpSampleRate);
won   = round((Trial.Bhv.getState('walk').state(:,1)-1)./Trial.xyzSampleRate.*Trial.lfpSampleRate);
woff  = round((Trial.Bhv.getState('walk').state(:,2)-1)./Trial.xyzSampleRate.*Trial.lfpSampleRate);

[fccg tbin ] = Trains2CCG({pposi,pnegi,won,woff,Trial.res},{1,2,3,4,Trial.clu},binSize,halfBins,Trial.lfpSampleRate,normalization);
uClu = unique(Trial.clu);
sccg = zeros(size(fccg,1),4,size(Trial.map,1));
sccg(:,:,uClu) = sq(fccg(:,1:4,5:end));
ffccg = zeros(size(fccg,1),4,size(Trial.map,1));
for k=1:size(Trial.map,1)
    for l=1:4
        ffccg(:,l,k) = Filter0(gausswin(3)./sum(gausswin(3)),sccg(:,l,k));
    end
end



[tlLag,tlInd,tlTrClu] =  TrigRasters(pposi,10000,Trial.res,Trial.clu,Trial.lfpSampleRate,1,[]);
[trLag,trInd,trTrClu] = TrigRasters(pnegi,10000,Trial.res,Trial.clu,Trial.lfpSampleRate,1,[]);

[tlLag,tlInd,tlTrClu] =  TrigRasters(npposi,10000,Trial.res,Trial.clu,Trial.lfpSampleRate,1,[]);
[trLag,trInd,trTrClu] = TrigRasters(npnegi,10000,Trial.res,Trial.clu,Trial.lfpSampleRate,1,[]);

[wonLag,wonInd,wonTrClu] =  TrigRasters(won,10000,Trial.res,Trial.clu,Trial.lfpSampleRate,1,[]);
[woffLag,woffInd,woffTrClu] = TrigRasters(woff,10000,Trial.res,Trial.clu,Trial.lfpSampleRate,1,[]);

LagSet = {tlLag,trLag,wonLag,woffLag};
IndSet = {tlInd,trInd,wonInd,woffInd};
TrCluSet = {tlTrClu,trTrClu,wonTrClu,woffTrClu};

figure
for unit=1:116
for i =1:4
subplot(220+i)
plot(LagSet{i}(TrCluSet{i}==unit)/1000,IndSet{i}(TrCluSet{i}==unit),'.','markersize',5);axis tight,grid on
title(num2str(unit));
end
waitforbuttonpress
end

%figure,for unit = 1:116,for i=1:2,subplot(210+i),bar(tbin/1000,ffccg(:,i,unit));axis tight;grid on,title(num2str(unit)),end,waitforbuttonpress,end
figure,for unit = 1:116,for i=1:4,subplot(220+i),bar(tbin/1000,sccg(:,i,unit));axis tight;grid on,title(num2str(unit)),end,waitforbuttonpress,end
figure,bar(tbin./1000,fccg(:,1,3)),axis tight
%figure,for unit = 1:116,for i=1:4,subplot(220+i),bar(tbin/1000,sccg(:,i,unit));axis tight;grid on,title(num2str(unit)),end,waitforbuttonpress,end
 % $$$ [twon,tonw,conw] =  TrigRasters(poni,10000,Res,Clu,Trial.lfpSampleRate,1,[]);
% $$$ [twoff,toffw,coffw] = TrigRasters(poffi,10000,Res,Clu,Trial.lfpSampleRate,1,[]);
%figure,for unit = 99:116,for i=1:4,subplot(220+i),bar(tbin/1000,ffccg(:,i,unit));axis tight;grid on,title(num2str(unit)),end,waitforbuttonpress,end


vsegs = GetSegs(comh,round(Trial.Bhv.getState('walk').state(:,1)-5*120),round(10*120),0);
vhfet = zeros(size(vsegs));
for i = 1:size(vsegs,2)
vhfet(:,i) = ButFilter(vsegs(:,i),11,2./(Trial.xyzSampleRate/2),'low');
end
figure,plot(median(vhfet.*12,2))
figure,plot(std(vhfet.*12,[],2))


vbsegs = GetSegs(comb,round(Trial.Bhv.getState('turnR').state(:,1)-5*120),round(10*120),0);
vbfet = zeros(size(vbsegs));
for i = 1:size(vbsegs,2)
vbfet(:,i) = ButFilter(vbsegs(:,i),11,2./(Trial.xyzSampleRate/2),'low');
end

figure,plot(median(vbfet,2)*12)
figure,plot(std(vbfet,[],2))


figure,hist(log10(clip(ButFilter(comh,11,2./(Trial.xyzSampleRate/ ...
                                             2),'low').*12,0.001,100)),




%% Play with these today
nfet = -Filter0(gausswin(141)./sum(gausswin(141)),abs(dbsfet.*Filter0(gausswin(141)./sum(gausswin(141)),comv(:,1)).*12))./(Trial.xyz(1:end-1,7,3)./Trial.ang(1:end-1,3,4,2)).*1000;
figure,hist(clip(Trial.ang(:,4,5,2)./Trial.ang(:,3,4,2).*Trial.xyz(:,7,3),-2500,2500),100)


rfet = clip(Trial.ang(:,4,5,2)./Trial.ang(:,3,4,2).*Trial.xyz(:,7,3),-2500,2500);

rper = ThreshCross(rfet,20,100);

figure,plot(nfet)

for i = 1:size(rper,1),
    nfet(rper(i,1):rper(i,2)) = -5;
end


Lines([],0,'k')
Lines(Trial.Bhv.getState('turnL').state(:,1),[],'k');
Lines(Trial.Bhv.getState('turnL').state(:,2),[],'r');
Lines(Trial.Bhv.getState('turnR').state(:,1),[],'k');
Lines(Trial.Bhv.getState('turnR').state(:,2),[],'r');
Lines(Trial.Bhv.getState('walk').state(:,1),[],'g');
Lines(Trial.Bhv.getState('walk').state(:,2),[],'m');



Lines(Trial.Bhv.getState('rear').state(:,1),[],'b');
Lines(Trial.Bhv.getState('rear').state(:,2),[],'c');

Lines(rper(:,1),[],'b');
Lines(rper(:,2),[],'c');



sfet = [unwrap(Trial.ang(:,2,3,1))-unwrap(Trial.ang(:,1,2,1)),...
        unwrap(Trial.ang(:,3,4,1))-unwrap(Trial.ang(:,2,3,1)),...
        unwrap(Trial.ang(:,4,5,1))-unwrap(Trial.ang(:,3,4,1)),...
        unwrap(Trial.ang(:,5,7,1))-unwrap(Trial.ang(:,4,5,1))];
sfet = unwrap(sfet);
sfet = Filter0(gausswin(win)./sum(gausswin(win)),sfet); % reduce noise
scsfet = Filter0(gausswin(241)./sum(gausswin(241)),sfet); % very slow components
bsfet = ButFilter(sum(sfet-scsfet,2),11,6./(Trial.xyzSampleRate/2),'low');
dbsfet = diff(bsfet);

nfet = -Filter0(gausswin(141)./sum(gausswin(141)),abs(dbsfet.*Filter0(gausswin(141)./sum(gausswin(141)),comv(:,1)).*12))./(Trial.xyz(1:end-1,7,3)./Trial.ang(1:end-1,3,4,2)).*1000;

for i = 1:size(rper,1),
    nfet(rper(i,1):rper(i,2)) = 0;
end



afet = [Trial.ang(:,2,3,1),...
        Trial.ang(:,3,4,1),...
        Trial.ang(:,4,5,1),...
        Trial.ang(:,5,7,1)]...
        -repmat(Trial.ang(:,1,2,1),1,4);
afet = unwrap(afet);
afet = Filter0(gausswin(win)./sum(gausswin(win)),afet);

ascfet = Filter0(gausswin(241)./sum(gausswin(241)),afet); % very slow components

caf = cumsum(sum(abs(afet-ascfet),2));

cafpersum = zeros(size(Trial.Bhv.getState('turnR').state,1),1);
for i =1:size(Trial.Bhv.getState('turnR').state,1),
    cafpersum(i) = sum(caf(Trial.Bhv.getState('turnR').state(i,1): ...
                           Trial.Bhv.getState('turnR').state(i,2)))/(Trial.Bhv.getState('turnR').state(i,2)-Trial.Bhv.getState('turnR').state(i,1));

end



[~,afetord] = sort(afet-ascfet,sort,2);


Lines([],0,'k')
Lines(Trial.Bhv.getState('turnL').state(:,1),[],'k',[],5);
Lines(Trial.Bhv.getState('turnL').state(:,2),[],'r',[],5);
Lines(Trial.Bhv.getState('turnR').state(:,1),[],'k',[],5);
Lines(Trial.Bhv.getState('turnR').state(:,2),[],'r',[],5);
Lines(Trial.Bhv.getState('walk').state(:,1),[],'g');
Lines(Trial.Bhv.getState('walk').state(:,2),[],'m');

Lines(Trial.Bhv.getState('groom').state(:,1),[],'k');
Lines(Trial.Bhv.getState('groom').state(:,2),[],'r');


figure,imagesc(afetord'),axis xy
fcomv =Filter0(gausswin(143)./sum(gausswin(143)),comv);
sfcomv =Filter0(gausswin(343)./sum(gausswin(343)),comv);





%% Silly stuff
snifet = diff(Filter0(gausswin(11)./sum(gausswin(11)),Trial.ang(:,4,5,3)));
[y,f,t] = mtchglong(WhitenSignal(diff(snifet)),2^7,Trial.xyzSampleRate,2^6,0.875*2^6,[],[],[],[0,40]);

figure,imagesc(t,f,log10(y)'),axis xy,
Lines(Trial.Bhv.getState('sniff').state(:,1)./Trial.xyzSampleRate,[],'k');
Lines(Trial.Bhv.getState('sniff').state(:,2)./Trial.xyzSampleRate,[],'r');

figure,imagesc(t,f,log10(y)'),axis xy,
Lines(Trial.Bhv.getState('walk').state(:,1)./Trial.xyzSampleRate,[],'k');
Lines(Trial.Bhv.getState('walk').state(:,2)./Trial.xyzSampleRate,[],'r');

lsp = median(y(:,f<7),2);
msp = median(y(:,f<15&f>7),2);
hsp = median(y(:,f<25&f>15),2);


lsp = mean(y(:,f<7),2);
msp = mean(y(:,f<15&f>7),2);
hsp = mean(y(:,f<25&f>15),2);

figure,plot(log10(lsp))
hold on
plot(log10(msp),'g')
plot(log10(hsp),'r')

spows = [lsp,msp,hsp];
walkspows = SelectPeriods(spows,round(Trial.Bhv.getState('walk').state(1:end-1,:)./Trial.xyzSampleRate.*(1/diff(t(1:2)))),'c',[],1);
cov(spows)
cov(walkspows)



figure,plot3(Trial.ang(:,3,4,1)-Trial.ang(:,2,3,1),...
             Trial.ang(:,2,3,1)-Trial.ang(:,1,2,1),...
             Trial.ang(:,5,7,1)-Trial.ang(:,4,5,1),'.')


