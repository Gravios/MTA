function genFets(Trial,varargin)
[window_length,win_long] = DefaultArgs(varargin,{[3.^(2:6)],3^6});

Trial = MTATrial('jg05-20120309',{'ang'},'all');

Trial.xyz = reshape(Filter0(gausswin(window_length(1))./sum(gausswin(window_length(1))),Trial.xyz),size(Trial.xyz,1),size(Trial.xyz,2),size(Trial.xyz,3));



comb = zeros(size(Trial.xyz,1),1,3);
comb(:,1,:) = Trial.com(Trial.Model.rb({'spine_lower','pelvis_root','spine_middle','spine_upper'}));
comh = zeros(size(Trial.xyz,1),1,3);
comh(:,1,:) = Trial.com(Trial.Model.rb({'head_back','head_left','head_front','head_right'}));

Trial = Trial.addMarker('body_com','[0,0,255]',...
                {{'spine_lower','body_com',[0,0,255]},...
                 {'pelvis_root','body_com',[0,0,255]},...
                 {'spine_middle','body_com',[0,0,255]},...
                 {'spine_upper','body_com',[0,0,255]}},comb);
Trial = Trial.addMarker('head_com','[0,0,0]',...
                {{'head_back','head_com',[0,0,255]},...
                 {'head_left','head_com',[0,0,255]},...
                 {'head_front','head_com',[0,0,255]},...
                 {'head_right','head_com',[0,0,255]}},comh);

Trial = Trial.load_ang(1);

%% ADD Body and head speed
v = sqrt(sum(diff(cat(2,comb,comh)).^2,3));
v = cat(1,v(1,:),v);
Features.raw = v;

%% ADD Body and head accel
a = diff(v);
a = cat(1,a,a(1,:));
Features.raw = cat(2,Features.raw,a);
clear('v')
clear('a')


%% ADD Body and head speed XY
v = sqrt(sum(diff(cat(2,comb(:,1,[1,2]),comh(:,1,[1,2]))).^2,3));
v = cat(1,v(1,:),v);
Features.raw = cat(2,Features.raw,v);

%% ADD Body and head accel XY
a = diff(v);
a = cat(1,a,a(1,:));
Features.raw = cat(2,Features.raw,a);
clear('v')
clear('a')


%% ADD Body and head speed Z
v = sqrt(sum(diff(cat(2,comb(:,1,[3]),comh(:,1,[3]))).^2,3));
v = cat(1,v(1,:),v);
Features.raw = cat(2,Features.raw,v);

%% ADD Body and head accel Z
a = diff(v);
a = cat(1,a,a(1,:));
Features.raw = cat(2,Features.raw,a);
clear('v')
clear('a')





%% ADD head to spine_lower distance
spine_length = Trial.ang(:,Trial.Model.gmi('spine_lower'),Trial.Model.gmi('head_front'),3);
spine_length(isnan(spine_length)) = mean(spine_length(~isnan(spine_length)));
Features.raw = cat(2,Features.raw,spine_length);
clear('spine_length')

%% ADD spine length
sl = Trial.ang(:,2,3,3)+Trial.ang(:,1,2,3)+Trial.ang(:,3,4,3)+Trial.ang(:,4,5,3);
sl(isnan(sl)) = mean(sl(~isnan(sl)));
Features.raw = cat(2,Features.raw,sl);
clear('sl')

%% ADD Marker to marker direction difference
sfet = [circ_dist(Trial.ang(:,2,3,1),Trial.ang(:,1,2,1)),...
        circ_dist(Trial.ang(:,2,3,1),Trial.ang(:,1,10,1)),...
        circ_dist(Trial.ang(:,3,4,1),Trial.ang(:,2,3,1)),...
        circ_dist(Trial.ang(:,3,4,1),Trial.ang(:,1,10,1)),...
        circ_dist(Trial.ang(:,4,5,1),Trial.ang(:,3,4,1)),...
        circ_dist(Trial.ang(:,4,5,1),Trial.ang(:,1,10,1)),...
        circ_dist(Trial.ang(:,5,7,1),Trial.ang(:,4,5,1)),...
        circ_dist(Trial.ang(:,5,7,1),Trial.ang(:,1,11,1))];
num_fet = size(sfet,2);
for i = 1:num_fet
   sfet(isnan(sfet(:,i)),i) = circ_mean(sfet(~isnan(sfet(:,i)),i));
end
Features.raw = cat(2,Features.raw,diff(sfet));
clear('sfet')

%% ADD Marker to marker pitch
pfet = [Trial.ang(:,1,2,2),...
        Trial.ang(:,2,3,2),...
        Trial.ang(:,3,4,2),...
        Trial.ang(:,4,5,2),...
        Trial.ang(:,5,6,2),...
        Trial.ang(:,5,7,2),...
        Trial.ang(:,5,8,2)];
num_fet = size(pfet,2);
for i = 1:num_fet
   pfet(isnan(pfet(:,i)),i) = circ_mean(pfet(~isnan(pfet(:,i)),i));
end
Features.raw = cat(2,Features.raw,pfet);
clear('pfet')

%% ADD Marker to marker distance for close pairs on body
dfet = [Trial.ang(:,1,2,2),...
        Trial.ang(:,2,3,2),...
        Trial.ang(:,3,4,2),...
        Trial.ang(:,4,5,2),...
        Trial.ang(:,4,6,2),...
        Trial.ang(:,4,7,2),...
        Trial.ang(:,4,8,2)];
num_fet = size(dfet,2);
for i = 1:num_fet
   dfet(isnan(dfet(:,i)),i) = circ_mean(dfet(~isnan(dfet(:,i)),i));
end
Features.raw = cat(2,Features.raw,dfet);
clear('dfet')



Features.raw = Filter0(gausswin(window_length(1))./sum(gausswin(window_length(1))),Features.raw);
Features.unorm = unity(Features.raw);



k=[1,4];
for i = 1:2,
Features.filt(:,:,i) = Filter0(gausswin(window_length(k(i)))./ ...
                               sum(gausswin(window_length(k(i)))),Features.raw);
end


Features.ufilt = unity(reshape(Features.filt,size(Features.filt,1),[]));

Features.wraw = WhitenSignal(Features.raw);






y=[];f=[];t=[];
for i=1:size(Features.wraw,2)
    [y(:,:,i),f,t] = mtchglong(Features.wraw(:,i),2^7,Trial.xyzSampleRate,2^6,2^6-1,[],[],[],[0,60]);
end

ym = zeros(size(y,1),5,size(y,3));
ym(:,1,:) = median(y(:,f<5,:),2);
ym(:,2,:) = median(y(:,f>5&f<10,:),2);
ym(:,3,:) = median(y(:,f>10&f<15,:),2);
ym(:,4,:) = median(y(:,f>15&f<20,:),2);
ym(:,5,:) = median(y(:,f>20&f<30,:),2);
ym = reshape(ym,size(ym,1),[]);

wper = Trial.Bhv.getState('walk').state;

wpt = zeros(size(Trial.xyz,1),1);
for i = 1:size(wper,1),
wpt(wper(i,1):wper(i,2)) = 1;
end



figure,hist(log10(y(y(:,60,28)~=0,60,28)),10000)
hold on,hist(log10(y(wpt==1&y(:,60,28)~=0,60,28)),10000)


for i = 1:size(y,3),
for j = 1:size(y,2),
[h(i,j),p(i,j)] = kstest2(log10(y(y(:,j,i)~=0,j,i)),log10(y(wpt==1&y(:,j,i)~=0,j,i)));
end
end

kstest(log10(y(y(:,5,28)~=0,5,28)))
kstest(log10(y(wpt==1&y(:,5,28)~=0,5,28)))
h = findobj(gca,'Type','patch');
set(h(2),'FaceColor','r','EdgeColor','r');



bc = cross(Trial.xyz(:,Trial.Model.gmi('body_com'),:)-Trial.xyz(:,Trial.Model.gmi('spine_lower'),:),Trial.xyz(:,Trial.Model.gmi('pelvis_root'),:)-Trial.xyz(:,Trial.Model.gmi('spine_lower'),:),3);
pc = cross(Trial.xyz(:,Trial.Model.gmi('body_com'),:)-Trial.xyz(:,Trial.Model.gmi('spine_upper'),:),Trial.xyz(:,Trial.Model.gmi('spine_middle'),:)-Trial.xyz(:,Trial.Model.gmi('spine_upper'),:),3);

% $$$ figure,imagesc(t(1:x),f,log10(yc(1:x,:,1,1))'),axis xy
% $$$ figure,imagesc(t(1:x),f,phi(1:x,:,1,2)'),axis xy
% $$$ Lines(Trial.Bhv.getState('walk').state(:,1)./Trial.xyzSampleRate,[],'k',[],5)
% $$$ Lines(Trial.Bhv.getState('walk').state(:,2)./Trial.xyzSampleRate,[],'r',[],5)
% $$$ 
% $$$ figure,imagesc(ta(1:x),fa,log10(ya(1:x,:,1,1))'),axis xy
% $$$ figure,imagescnan(phia(1:x,:,1,2)',[],1),axis xy
% $$$ Lines(Trial.Bhv.getState('walk').state(:,1)./Trial.xyzSampleRate,[],'k',[],5)
% $$$ Lines(Trial.Bhv.getState('walk').state(:,2)./Trial.xyzSampleRate,[],'r',[],5)

figure,plot(diff(Filter0(gausswin(21)./sum(gausswin(21)),dot(sq(pc),sq(pc),2))))
hold on,plot(diff(Filter0(gausswin(21)./sum(gausswin(21)),dot(sq(bc),sq(bc),2))),'g')

Lines(Trial.Bhv.getState('walk').state(:,1),[],'g');
Lines(Trial.Bhv.getState('walk').state(:,2),[],'m');
Lines(Trial.Bhv.getState('rear').state(:,1),[],'k');
Lines(Trial.Bhv.getState('rear').state(:,2),[],'r');
Lines(Trial.Bhv.getState('turnR').state(:,1),[],'b');
Lines(Trial.Bhv.getState('turnR').state(:,2),[],'c');

k=[1,5];
for i = 1:2,
Features.filt(:,:,i) = Filter0(gausswin(window_length(k(i)))./ ...
                               sum(gausswin(window_length(k(i)))),Features.raw);
end


Features.ufilt = unity(reshape(Features.filt,size(Features.filt,1),[]));

allcov = cov(Features.ufilt(:,:));
bhvstates = {'walk','turnR','turnL','rear','groom'};
bhvcov = [];
fpt = zeros(size(Trial.xyz,1),length(bhvstates));
bhvcov = zeros(size(Features.ufilt,2),size(Features.ufilt,2),length(bhvstates));
for s = 1:length(bhvstates),
fper = Trial.Bhv.getState(bhvstates{s}).state;
for i = 1:size(fper,1),
fpt(fper(i,1):fper(i,2),s) = 1;
end
bhvcov(:,:,s) = cov(Features.ufilt(fpt(:,s)==1,:));
%bhvpc(:,:,s) =  princomp(Features.ufilt(fpt==1,:));
end


figure,hold on
color = {'b','g','r','k','c'};
for s = 1:length(bhvstates),
plot(Features.ufilt*bhvpc(1,:,s)',color{s})
title(bhvstates{s});
end

figure
subplotfit(1,6)
imagesc(real(log(allcov)'))
for s = 2:6,subplotfit(s,6),imagesc(real(log(bhvcov(:,:,s-1)'))),end



s=4;

%lwc = -0.5.*log(abs(bhvcov(:,:,s)));
fufsm = Features.ufilt-repmat(mean(Features.ufilt(fpt(:,s)==1,:)),size(Features.ufilt,1),1);
lwpri = log(sum(fpt(:,s)==1)/length(fpt(:,s)));
iwcm = bhvcov(:,:,s)^-1;

tws = 40000;
twi = zeros(tws,1);
%             *bhvcov(:,:,1)...
for i = 1:tws,
twi(i) = -0.5*fufsm(i,:)*iwcm*fufsm(i,:)'+lwpri;
end
%ylim([-1e7,1e7])
%xlim([0,tws])


figure,plot(log10(Filter0(gausswin(61)./sum(gausswin(61)),abs(twi))))

Lines(Trial.Bhv.getState('walk').state(:,1),[],'g');
Lines(Trial.Bhv.getState('walk').state(:,2),[],'m');

Lines(Trial.Bhv.getState('rear').state(:,1),[],'k');
Lines(Trial.Bhv.getState('rear').state(:,2),[],'r');

Lines(Trial.Bhv.getState('turnR').state(:,1),[],'b');
Lines(Trial.Bhv.getState('turnR').state(:,2),[],'c');

Lines(Trial.Bhv.getState('turnL').state(:,1),[],'k');
Lines(Trial.Bhv.getState('turnL').state(:,2),[],'r');

Lines(Trial.Bhv.getState('groom').state(:,1),[],'k');
Lines(Trial.Bhv.getState('groom').state(:,2),[],'r');


bhvstates = {'walk','turnR','turnL','rear','groom'};


%% spectral QDA

uym = log10(ym);
for i = 1:size(uym,2),
muym(i) = mean(uym(~isnan(uym(:,i))&~isinf(uym(:,i)),i));
end

for i = 1:size(uym,2),
suym(i) = std(uym(~isnan(uym(:,i))&~isinf(uym(:,i)),i));
end
guym = (uym-repmat(muym,size(uym,1),1))./repmat(suym,size(uym,1),1);


uym = log10(ym(:,1:20));

muym= [];
for i = 1:size(uym,2),
muym(i) = mean(uym(~isnan(uym(:,i))&~isinf(uym(:,i)),i));
end

suym = []
for i = 1:size(uym,2),
suym(i) = std(uym(~isnan(uym(:,i))&~isinf(uym(:,i)),i));
end
guym = (uym-repmat(muym,size(uym,1),1))./repmat(suym,size(uym,1),1);


sallcov = cov(guym(~isnan(guym(:,1))&~isinf(guym(:,1)),:));
bhvstates = {'walk','turnR','turnL','rear','groom'};
sbhvcov = zeros(size(guym,2),size(guym,2),length(bhvstates));
for s = 1:length(bhvstates),
sbhvcov(:,:,s) = cov(guym(~isnan(guym(:,1))&~isinf(guym(:,1))&fpt(1:size(guym,1),s)==1,:));
end

s=1;
tws = 40000;
%lwc = -0.5.*log(abs(bhvcov(:,:,s)));
%ymfsm = log10(ym(1:tws,:))-repmat(mean(log10(ym(fpt(1:size(ym,1),s)==1,:))),tws,1);
ymfsm = log10(guym(1:tws,:))-repmat(mean(guym(fpt(1:size(guym,1),s)==1,:)),tws,1);
lwpri = log(sum(fpt(:,s)==1)/length(fpt(:,s)));
isbcm = inv(sbhvcov(:,:,s));

twi = zeros(tws,1);
for i = 1:tws,
twi(i) = -0.5*ymfsm(i,:)*isbcm*ymfsm(i,:)'+lwpri;
end


winl = 21;
figure,plot(log10(Filter0(gausswin(winl)./sum(gausswin(winl)),abs(twi))))

Lines(Trial.Bhv.getState('walk').state(:,1),[],'g',[],5);
Lines(Trial.Bhv.getState('walk').state(:,2),[],'m',[],5);

Lines(Trial.Bhv.getState('rear').state(:,1),[],'k');
Lines(Trial.Bhv.getState('rear').state(:,2),[],'r');


Lines(Trial.Bhv.getState('turnR').state(:,1),[],'b');
Lines(Trial.Bhv.getState('turnR').state(:,2),[],'c');
Lines(Trial.Bhv.getState('turnL').state(:,1),[],'k');
Lines(Trial.Bhv.getState('turnL').state(:,2),[],'r');

Lines(Trial.Bhv.getState('groom').state(:,1),[],'k');
Lines(Trial.Bhv.getState('groom').state(:,2),[],'r');


bhvstates = {'walk','turnR','turnL','rear','groom'};
