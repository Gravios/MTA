Trial = MTATrial('jg05-20120309',{'ang'},'all');

fwin = 9;
Trial.xyz = reshape(Filter0(gausswin(fwin)./sum(gausswin(fwin)),Trial.xyz),size(Trial.xyz,1),size(Trial.xyz,2),size(Trial.xyz,3));

comb = zeros(size(Trial.xyz,1),1,3);
comb(:,1,:) = Trial.com(Trial.Model.rb({'spine_lower','pelvis_root','spine_middle','spine_upper'}));
comh = zeros(size(Trial.xyz,1),1,3);
comh(:,1,:) = Trial.com(Trial.Model.rb({'head_back','head_left','head_front','head_right'}));

Trial = Trial.addMarker('body_com','[0,0,255]',...
                {{'spine_lower','body_com',[0,0,255]},...
                 {'pelvis_root','body_com',[0,0,255]},...
                 {'spine_middle','body_com',[0,0,255]},...
                 {'spine_upper','body_com',[0,0,255]}},comb);
Trial = Trial.addMarker('head_com','[0,0,0]',...
                {{'head_back','head_com',[0,0,255]},...
                 {'head_left','head_com',[0,0,255]},...
                 {'head_front','head_com',[0,0,255]},...
                 {'head_right','head_com',[0,0,255]}},comh);
Trial = Trial.load_ang(1);


sfet = [circ_dist(Trial.ang(:,2,3,1),Trial.ang(:,1,2,1)),...
        circ_dist(Trial.ang(:,2,3,1),Trial.ang(:,1,10,1)),...
        circ_dist(Trial.ang(:,3,4,1),Trial.ang(:,2,3,1)),...
        circ_dist(Trial.ang(:,3,4,1),Trial.ang(:,1,10,1)),...
        circ_dist(Trial.ang(:,4,5,1),Trial.ang(:,3,4,1)),...
        circ_dist(Trial.ang(:,4,5,1),Trial.ang(:,1,10,1)),...
        circ_dist(Trial.ang(:,5,7,1),Trial.ang(:,4,5,1)),...
        circ_dist(Trial.ang(:,5,7,1),Trial.ang(:,1,11,1))];

pfet = [Trial.ang(:,1,2,2),...
        Trial.ang(:,2,3,2),...
        Trial.ang(:,3,4,2),...
        Trial.ang(:,4,5,2),...
        Trial.ang(:,5,6,2),...
        Trial.ang(:,5,7,2),...
        Trial.ang(:,5,8,2)];

%xyz = cat(2,sfet,pfet);
markers = [1,2,3,4,5,6,7,8];
fwin = 63;
xyz = reshape(Filter0(gausswin(fwin)./sum(gausswin(fwin)),Trial.xyz(:,markres,:),size(Trial.xyz,1),length(markers),size(Trial.xyz,3));


xyzlen = size(xyz,1);
winlen = 64;
zpad = mod(xyzlen,winlen);

if zpad~=0,
%% add script to pad xyz with zeros so future matrix
%% reshaping functions will work.
xyzlen = size(xyz,1);
end 

nOverlap = 4;

trajSampleRate = (Trial.xyzSampleRate/winlen)*nOverlap;
trlen = xyzlen/winlen*nOverlap;

traj =[];
for i = 1:nOverlap,
ttraj = reshape(circshift(xyz,-(i-1).*winlen/nOverlap),[],xyzlen/winlen,size(xyz,2),size(xyz,3));
ttraj = reshape(ttraj,size(ttraj,1),size(ttraj,2),[]);
traj(:,i:nOverlap:trlen,:) = ttraj-repmat(ttraj(1,:,:),winlen,1);
end

%ntraj = traj./repmat(max(traj),winlen,1);

trajCov  = zeros(size(traj,2),size(traj,3),size(traj,3));

for i=1:size(traj,2),
trajCov(i,:,:) = cov(sq(traj(:,i,:)));
end


%for i=1:size(traj,2), imagesc(sq(trajCov(i,:,:))'),pause(.15),end

%%Bhv state Walk
wper = round(Trial.Bhv.getState('walk').state./Trial.xyzSampleRate.*trajSampleRate);
wper = wper(find(diff(wper,1,2)>8),:);
wtrajCov = SelectPeriods(trajCov,wper+repmat([0,-0.5*nOverlap],size(wper,1),1),'c',1,1);
wtrajCov = reshape(wtrajCov,size(wtrajCov,1),size(trajCov,2),size(trajCov,2));

wcoffset = 1000;
wscore = zeros(1000,500);%zeros(size(trajCov,1),1);

for i=503:size(wscore,1)
    if sum(sum(sq(trajCov(i,:,:))))==0
        wscore(i,:) = -1;
        continue,
    end
    tcis = sq(trajCov(i,:,:))^-1/2;
    if sum(sum(tcis))==0|sum(isinf(tcis(:)))>=1|sum(isnan(tcis(:)))>=1,
        wscore(i,:) = -1;
        continue,
    end
    for j = 1:size(wscore,2);
    wtc = sq(wtrajCov(j+wcoffset,:,:));
    if sum(sum(wtc))==0|sum(isinf(wtc(:)))>=1|sum(isnan(wtc(:)))>=1,
        wscore(i,:) = -1;
        continue,
    end
         wscore(i,j) = norm(tcis*wtc*tcis,'fro');
        %dcov = tcis*wtc*tcis;
        
        %deig = real(eig(dcov));
        %wscore(i,j) =log(max(deig))-log(min(deig));
    end
end

wscore(wscore==-1)=nan;

figure,plot(log10(min(real(wscore),[],2)))
hold on,plot(Filter0(gausswin(11)./sum(gausswin(11)),log10(min(real(wscore),[],2))))
hold on,plot(log10(max(real(wscore),[],2)),'r')
hold on,plot(log10(mean(real(wscore),2)),'g')
Lines(round(Trial.Bhv.getState('walk').state(:,1)./Trial.xyzSampleRate.*trajSampleRate),[],'k');
Lines(round(Trial.Bhv.getState('walk').state(:,2)./Trial.xyzSampleRate.*trajSampleRate),[],'r');

figure,plot(std(real(wscore),[],2))
Lines(round(Trial.Bhv.getState('walk').state(:,1)./Trial.xyzSampleRate.*trajSampleRate),[],'k');
Lines(round(Trial.Bhv.getState('walk').state(:,2)./Trial.xyzSampleRate.*trajSampleRate),[],'r');


slws = sort(log10(real(wscore)));
figure,plot(slws(:,1)
Lines(round(Trial.Bhv.getState('walk').state(:,1)./Trial.xyzSampleRate.*trajSampleRate),[],'k');
Lines(round(Trial.Bhv.getState('walk').state(:,2)./Trial.xyzSampleRate.*trajSampleRate),[],'r');





twtrajCov = permute(wtrajCov,[2,3,1]);
wCovScore = zeros(size(twtrajCov,3),size(twtrajCov,3));
for i=1:size(wCovScore,1)
    tcis = sq(twtrajCov(:,:,i));
    for j = 1:size(wCovScore,2);
    wtc = sq(twtrajCov(:,:,j));
         wCovScore(i,j) = norm(tcis*wtc*tcis,'fro');
    end
end

figure,imagesc(log(wCovScore)')


rtrajCov = SelectPeriods(trajCov,round(Trial.Bhv.getState('turnR').state./Trial.xyzSampleRate.*trajSampleRate),'c',1,1);
rtrajCov = reshape(rtrajCov,size(rtrajCov,1),size(trajCov,2),size(trajCov,2));
%rCov = cov(reshape(rtrajCov,size(rtrajCov,1),[]));
rmCov =sq(mean(rtrajCov));
rsCov =sq(std(rtrajCov));
figure,imagesc(rmCov'),colorbar
figure,imagesc(rsCov'),colorbar

iwCovSet = zeros(size(wtrajCov,1),size(wtrajCov,3),size(wtrajCov,3));
for i=1:size(wtrajCov,1)
iwCovSet(i,:,:) = inv(sq(wtrajCov(i,:,:)));
end

for i=1:size(trajCov),
wscore(i) = rtrajCov(i,:)*iwCov*rtrajCov(i,:)';
end



wCov = cov(reshape(wtrajCov,size(wtrajCov,1),[]));
iwCov = inv(wCov);
rtrajCov = reshape(trajCov,size(trajCov,1),[]);

wscore = zeros(size(trajCov,1),1);
for i=1:size(trajCov),
wscore(i) = rtrajCov(i,:)*iwCov*rtrajCov(i,:)';
end


figure,imagesc(log(abs(wscore)))

figure,plot(log(abs(wscore)))
Lines(round(Trial.Bhv.getState('walk').state(:,1)./Trial.xyzSampleRate.*trajSampleRate),[],'k')
Lines(round(Trial.Bhv.getState('walk').state(:,2)./Trial.xyzSampleRate.*trajSampleRate),[],'r')

