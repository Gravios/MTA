#! /bin/bash
# setup the MTA environment for a new user
#
#
# MTA assumes a specifec file structure for both data and code
#
# matlab code - expected location: /storage/code/matlab
# data        - expected location: /storage/$USER/data
#
# USER is your user name
#
# STORAGE is the location of your user DATA folder
#         e.g. /storage
#         NOT  /home
#
# example
#     configure -u gravio -s storage2 -m /storage/gravio/code/matlab
# 

USER=''
STORAGE=''
MTA=''
MATLAB=''
SHARE=''

while getopts u:s:m:p: option ;
do
    case "${option}" 
    in
    u) USER=${OPTARG};;
    s) STORAGE=${OPTARG};;
    a) MTA=${OPTARG};;
    m) MATLAB=${OPTARG};;
    r) SHARE=${OPTARG};;    
    esac
done


if [ -z "$USER" ]; then
    USER=`whoami`
fi

if [ -z "$MTA" ]; then
    #SOURCE="${BASH_SOURCE[0]}"
    #while [ -h "$SOURCE" ]; do
    #    # resolve $SOURCE until the file is no longer a symlink
    #    DIR="$( cd -P "$( dirname "$SOURCE" )" >/dev/null 2>&1 && pwd )"
    #    SOURCE="$(readlink "$SOURCE")"
    #    # if $SOURCE was a relative symlink, we need to resolve it relative to the
    #    # path where the symlink file was located
    #    [[ $SOURCE != /* ]] && SOURCE="$DIR/$SOURCE" 
    #done
    #MTA="$( cd -P "$( dirname "$SOURCE" )" >/dev/null 2>&1 && pwd )"
    MTA="$( cd "$( dirname "${BASH_SOURCE[0]}" )" >/dev/null 2>&1 && pwd )"
fi

if [ -z "$STORAGE" ]; then
    if [ -d /storage/$USER ]; then   
        STORAGE="storage"
    elif [ -d /storage2/$USER ]; then
        STORAGE="storage2"
    fi
fi
   
echo /$STORAGE/$USER

if [ -z "$MATLAB" ]; then
    MATLAB="/$STORAGE/$USER/code/matlab/"
    if [ ! -d "/$STORAGE/$USER/code" ]; then
	mkdir "/$STORAGE/$USER/code"
    fi
    
    if [ ! -d "/$STORAGE/$USER/code/matlab" ]; then
	mkdir "/$STORAGE/$USER/code/matlab"
    fi
    
fi

if [ -z "$SHARE" ]; then
    SHARE="/storage/share/matlab"
fi

# COPY MTAstartup to user's matlab directory
cp "$MTA/config/MTAstartup.m" "$MATLAB/MTAstartup.m"

# APPEND MTAstartup to the end of user's matlab startup file

# ASSUMING the matlab startup is located in the $MATLAB directory
# ADD commands to startup.m to create paths to labbox
# RUN commands to startup.m to run MTAstartup.m
echo "addpath(genpath('$SHARE/labbox'));"       >> "/home/$USER/startup.m"
echo "rmpath( genpath('$SHARE/labbox/.git'));"  >> "/home/$USER/startup.m"
echo "global MTA_PATH;"                         >> "/home/$USER/startup.m"
echo "MTA_PATH = getenv('MTA_PATH');"           >> "/home/$USER/startup.m"

echo "addpath('$MTA/utilities');"               >> "/home/$USER/startup.m"
echo "MTAstartup();"                            >> "/home/$USER/startup.m"

# ADD environmental variables to aid MTAstartup and MTAconfiguration
echo 'export MTA=$MTA'                                         >> "~/.bashrc"
echo 'export MTA_DATA_PATH="/$STORAGE/$USER/data/"'            >> "~/.bashrc"
echo 'export MTA_PROJECT_PATH="/$STORAGE/$USER/data/project"'  >> "~/.bashrc"

source '~/.bashrc'
