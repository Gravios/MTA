function rear_state = rear_hmm(Session,varargin)
[minimum_interval,min_inter_rear_duration,hmm_states,display] = DefaultArgs(varargin,{50,10,3,0});

figure,hold on, plot(t,(Session.xyz(:,,3)-Session.xyz(:,1,3)),'r') 
plot(s.xyz(:,5,3))
plot((abs(s.xyz(:,5,3)-s.xyz(:,2,3)).*s.ang(:,1,2,2).*s.ang(:,2,3,2).*s.ang(:,3,4,2).*s.ang(:,4,5,2).*s.ang(:,5,7,2)),'k')
figure,hist((abs(s.xyz(:,5,3)-s.xyz(:,2,3)).*s.ang(:,1,2,2).*s.ang(:,2,3,2).*s.ang(:,3,4,2).*s.ang(:,4,5,2).*s.ang(:,5,7,2)),5000)

rear_fet = abs((Session.xyz(:,Session.Model.gmi('head_back'),3)-Session.xyz(:,Session.Model.gmi('spine_lower'),3)).*Session.ang(:,Session.Model.gmi('pelvis_root'),Session.Model.gmi('spine_middle'),2).*Session.ang(:,Session.Model.gmi('spine_middle'),Session.Model.gmi('spine_upper'),2).*Session.ang(:,Session.Model.gmi('spine_upper'),Session.Model.gmi('head_back'),2)); 
rear_fet(isnan(rear_fet))=0;


[State, hmm, decode] = gausshmm(rear_fet,hmm_states);
[~, rearstate ] = max(cat(1,hmm.state.Mu));
rear = zeros(size(rear_fet));
rear(State==rearstate) = 1;
rear(1) = 0;
rear(end) = 0;

rearPeriods = ThreshCross(rear,0.5,minimum_interval);

interRearPeriods = [[0,rearPeriods(1,1)];[rearPeriods(1:end-1,2),rearPeriods(2:end,1)];[rearPeriods(end,2),size(rear,1)]];
interRearDuration = diff(interRearPeriods,1,2);
false_rear_off_ind = find(interRearDuration<min_inter_rear_duration);
if size(false_rear_off_ind,1)>0,
    rpt = rearPeriods;
    rpt(false_rear_off_ind,:) = [rearPeriods(false_rear_off_ind,1) rearPeriods(false_rear_off_ind+1,2)];
    rpt(false_rear_off_ind+1,:) =0;
    rearPeriods = reshape(rpt(find(rpt)),[],2);
end

rear_state = zeros(size(rear));
for i = 1:size(rearPeriods,1)
    rear_state(rearPeriods(i,1):rearPeriods(i,2))=1;
end


if display,

    figure, hold on
    plot(rear_fet)
    plot(rear_state*max(rear_fet)/2+max(rear_fet)/8,'r');

    figure,
    hist(rear_fet,5000)

    figure,hold on
    plot(rear_fet)
    plot(rear*100,'r')

end
